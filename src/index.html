<!DOCTYPE html>
<html>

<head>
  <title>StudentEngagementMonitoring</title>

  <style type="text/css">
    body {
      font-size: 150%;
      font-family: "Tenorite", "Segoe UI", sans-serif;
    }


    #logo {
      font-weight: 600;
      color: #505050;
      margin: 1em;
    }

    #sem {
      text-align: center;
      margin-top: 1em;
    }

    #left {
      min-width: 510px;
      margin: 0px 0px 10px 0px;
    }

    @media only screen and (min-width: 950px) {
      #left, #right {
        display: inline-block;
        vertical-align: top;
        max-width: 49%;
      }
      textarea {
        height: 140px;
      }
    }

    #inputs {
      background-color: #d5d8dc;
    }

    #inputs, #inputs input, textarea {
      font-size: 90%;
      font-family: monospace;
      font-weight: 600;
      color: #2a2a2a;
    }

    .input-div-2 {
      background-color: #abb2b9;
    }

    #output {
      background-color: #808b96;
      line-height: 0;
    }

    label {
      display: inline-block;
      padding: 4px;
      margin: 4px;
    }

    label.display-item {
      width: 250px;
      text-align: right;
    }

    input.display-attendance {
      background-color: white;
      padding: 0px 0px 0px 8px;
      margin: 4px;
      font-family: monospace;
      letter-spacing: 0.1em;
      width: 40px;
      line-height: 180%;
    }

    label.out-of {
      width: 150px;
      text-align: left;
    }

    textarea.display-output {
      background-color: #d5d8dc;
      padding: 5px;
      margin: 10px;
      font-family: monospace;
      width: 480px;
      border: none;
    }

    button {
      font-family: "Tenorite", "Segoe UI", sans-serif;
      font-weight: 500;
      color: white;
      padding: 0px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 18px;
      margin: 0px 2px 4px 2px;
      cursor: pointer;
      height: 50px;
      width: 400px;
    }

    button:hover {
      border-width: 5px;
      transition-duration: 0.3s;
    }

    .sembutton-active {
      background-color: #2874a6;
    }

    .sembutton-inactive {
      background-color: gray;
    }

    .sembutton-clear {
      background-color: #c0392b;
    }
  </style>

</head>

<body>
  <div id="sem">
    <div id="logo">
      Student Engagement Monitoring
    </div>
    <div id="left">
      <div id="inputs">
      </div>
      <div id="output">
        <textarea class="display-output" id="output-text" rows="5" cols="35" readonly=1 placeholder="Results here..."
          value=""></textarea>
      </div>
    </div>
    <div id="right">
      <div>
        <button class="sembutton-active" onclick="getMaxMin();">Maximum and Minimum Attendance</button>
      </div>
      <div>
        <button class="sembutton-active" onclick="getSortedAttendance();">Sort Attendance</button>
      </div>
      <div>
        <button class="sembutton-inactive" onclick="getTotal();">Total Attendance Hours</button>
      </div>
      <div>
        <button class="sembutton-inactive" onclick="getEngagementScore();">Student Engagement Score</button>
      </div>
      <div>
        <button class="sembutton-inactive" onclick="getRisk();">Risk of Student Failure</button>
      </div>
      <div>
        <button class="sembutton-inactive" onclick="getPercentages();">Percentage Attendances</button>
      </div>
      <div>
        <button class="sembutton-clear" onclick="reset();">Clear</button>
      </div>
    </div>
  </div>
</body>

<script type="text/javascript">

  // To be replaced by storage
  let params = [
    {
        "item": "Lecture sessions",
        "default": null,
        "available": 33,
        "unit": "hours"
    },
    {
        "item": "Lab sessions",
        "default": null,
        "available": 22,
        "unit": "hours"
    },
    {
        "item": "Support sessions",
        "default": null,
        "available": 44,
        "unit": "hours"
    },
    {
        "item": "Canvas activities",
        "default": null,
        "available": 55,
        "unit": "hours"
    },
    {
        "item": "Cutoff Engagement Score",
        "default": 70,
        "available": 100,
        "unit": "%"
    }
  ]

  // To be replaced by proxy
  let maxminURL = "http://semmaxmin.40103709.qpc.hal.davecutting.uk/";
  let sortURL = "http://semsort.40103709.qpc.hal.davecutting.uk/";

  if (!isRunningOnCloud()) {
    maxminURL = "http://localhost:90/";
    sortURL = "http://localhost:100/";
  }

  reset()

  function isRunningOnCloud() // GPT-3.5
  {
    const localPatterns = [
      /localhost$/, // amended to include wsl.localhost
      /^127\.0\.0\.1$/,
      /^::1$/,
      /^0\.0\.0\.0$/,
      /^.*\.local$/,
      /^.*\.dev$/,
    ];

    const hostname = window.location.hostname;

    for (const pattern of localPatterns) {
      if (pattern.test(hostname)) {
        return false; // It's running locally
      }
    }

    return true; // It's running on the cloud
  }

  function zero(value) {
    if (value == '') value = 0;
    return value;
  }

  function validateAttendances(uRL) {
    let items = [];
    let attendances = [];
    let hasNext = true;
    let id = 1;
    let querystring = `${uRL}?marco=polo`;

    while (hasNext) {
      items.push(document.getElementById(`item_${id}`).value);
      attendances.push(zero(document.getElementById(`attendance_${id}`).value));
      querystring += `&item_${id}=${items[id - 1]}&attendance_${id}=${attendances[id - 1]}`
      id++;
      if (document.getElementById(`item_${id}`) == null || document.getElementById(`attendance_${id}`) == null) hasNext = false;
    };

    return { items, attendances, querystring }
  }

  function displayMaxMin(max_attendance, min_attendance) {
    document.getElementById('output-text').value = 
      'Maximum attendance = ' + max_attendance + ' hours'
      + '\nMinimum attendance = ' + min_attendance + ' hours';
  }

  function displaySortedAttendance(text) {
    document.getElementById('output-text').value = text;
  }

  function displayTotal(total) {
    document.getElementById('output-text').value = 'Total Attendance = ' + total + ' hours';
  }

  function displayEngagementScore(score) {
    document.getElementById('output-text').value = 'Engagement score TBD';
  }

  function displayRisk(risk) {
    document.getElementById('output-text').value = 'Risk of failure TBD';
  }

  function displayPercentages(text) {
    document.getElementById('output-text').value = 'Percentages TBC';
  }

  function getMaxMin() {
    const { items, attendances, querystring } = validateAttendances(maxminURL);

    console.log(querystring);

    let xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        //let response = this.response
        var j = JSON.parse(this.response);
        console.log('test -- ' + j.max_item);
        let max_attendance = j.max_item;
        let min_attendance = j.min_item;
        displayMaxMin(max_attendance, min_attendance);

      }
    };
    xhttp.open("GET", querystring);
    xhttp.send();
    return;
  }

  function getSortedAttendance() {

    const { items, attendances, querystring } = validateAttendances(sortURL);

    let xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var j = JSON.parse(this.response);
        console.log(j);
        let sorted_attendance_returned = j.sorted_attendance;
        let sorted_attendance = '';
        for (let i = 0; i < sorted_attendance_returned.length; i++) {
          sorted_attendance += sorted_attendance_returned[i]['item'] + ' - ' + sorted_attendance_returned[i]['attendance'] + ' hours' + '\r\n';
        }
        displaySortedAttendance(sorted_attendance);
      }
    };
    xhttp.open("GET", querystring);
    xhttp.send();
    return;
  }

  function getTotal() {
    const { items, attendances, querystring } = validateAttendances(sortURL);
    total = 0;
    // attendances.forEach((attendance)=>{
    //   total+=parseInt(attendance)
    // });
    displayTotal(total);
    return;
  }

  function getEngagementScore() {
    displayEngagementScore()
    return;
  }

  function getRisk() {
    displayRisk()
    return;
  }

  function getPercentages() {
    displayPercentages()
    return;
  }

  function reset() {

    let inputs1 = "";

    for (id=1; id<=params.length; id++) {
      inputs1 += `<div class="input-div-${(params[id-1]['default']) ? "2" : "1"}">
        <label class="display-item">${params[id-1]['item']}</label>
        <input class="display-item" type="hidden" id="item_${id}" name="item_${id}" value="${params[id-1]['item']}">
        <input class="display-attendance" type="number" min="0" max="${params[id-1]['available']}" id="attendance_${id}" name="attendance_${id}" placeholder="00" ${(params[id-1]['default']) ? 'value="'+params[id-1]['default']+'"' : ""}><label class="out-of">/${params[id-1]['available']} ${params[id-1]['unit']}</label>
      </div>`
    }

    document.getElementById('inputs').innerHTML = inputs1

    document.getElementById('output').value = '';
  }


</script>

<script type="text/javascript">
</script>

</html>